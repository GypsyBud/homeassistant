- alias: 17Track Updates
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        - sensor.packages_delivered
        - sensor.packages_in_transit
  condition:
    - condition: template
      value_template: '{{ (trigger.to_state.state | int ) > 0 }}'
  action:
    - service: notify.gmaillolo
      data_template:
        message: >
          {{ trigger.to_state.state }} {{ trigger.entity_id | replace("sensor.","seventeentrack") | replace("_"," ") |capitalize }}
          {% for state in states.sensor -%}
          {% if (state.entity_id|replace("sensor.","")).split("_")[0] == "seventeentrack" %}
          Sensor: {{state.entity_id}}
          Tracking #: {{state.attributes.tracking_number}} (https://t.17track.net/en#nums={{state.attributes.tracking_number}})
          Location: {{state.attributes.location}}
          Last Updated: {{as_timestamp(state.last_changed)|timestamp_custom('%X on %d %h %Y',false)}}
          {% endif %}
          {%- endfor %}
